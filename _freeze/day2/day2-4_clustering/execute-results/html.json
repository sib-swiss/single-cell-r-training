{
  "hash": "a9a9baf24323fcc7c1ae99ca2dcc7243",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Clustering\"\neditor_options: \n  chunk_output_type: console\n---\n\n\n\n\n## Material\n\n\n\n{{< downloadthis ../assets/pdf/202503_clustering.pdf dname=\"Clustering_SIB\" label=\"Download the presentation\" icon=\"filetype-pdf\" >}}\n\n\n{{< video https://youtu.be/kqcvqqZp3Jo?si=T1lHw0z-4wv6BvF- >}}\n\n\n{{< downloadthis ../assets/pdf/scRNAseq_clustering_RM.pdf dname=\"scRNAseq_clustering_RM\" label=\"Download the presentation from the video\" icon=\"filetype-pdf\" >}}\n\n\n\n\n\n\n- Evaluation of [clustering methods](https://f1000research.com/articles/7-1141)\n\n## Exercises\n\nLoad the `seu` dataset you have created earlier today:\n\n\n\n::: {.cell}\n\n:::\n\n\n\nThe method implemented in Seurat first constructs a SNN graph based on the euclidean distance in PCA space, and refine the edge weights between any two cells based on the shared overlap in their local neighborhoods (Jaccard similarity). This step is performed using the `FindNeighbors()` function, and takes as input the previously defined dimensionality of the dataset.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseu <- Seurat::FindNeighbors(seu, dims = 1:25, reduction = \"integrated.cca\")\n```\n:::\n\n\n\nTo cluster the cells, Seurat next implements modularity optimization techniques such as the Louvain algorithm (default) or SLM [SLM, Blondel et al., Journal of Statistical Mechanics], to iteratively group cells together, with the goal of optimizing the standard modularity function. The `FindClusters()` function implements this procedure, and contains a resolution parameter that sets the ‘granularity’ of the downstream clustering, with increased values leading to a greater number of clusters.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseu <- Seurat::FindClusters(seu, resolution = seq(0.1, 0.8, by=0.1))\n```\n:::\n\n\n\nCluster id of each cell is added to the metadata object, as a new column for each resolution tested:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(seu@meta.data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                           orig.ident nCount_RNA nFeature_RNA percent.mito\nPBMMC-1_AAACCTGCAGACGCAA-1    PBMMC-1       2401          909     2.540608\nPBMMC-1_AAACCTGTCATCACCC-1    PBMMC-1       3532          760     5.181200\nPBMMC-1_AAAGATGCATAAAGGT-1    PBMMC-1       3972         1215     4.934542\nPBMMC-1_AAAGCAAAGCAGCGTA-1    PBMMC-1       3569          894     3.250210\nPBMMC-1_AAAGCAACAATAACGA-1    PBMMC-1       2982          730     3.688799\nPBMMC-1_AAAGCAACATCAGTCA-1    PBMMC-1      22284         3108     3.181655\n                           percent.ribo percent.globin nCount_SCT nFeature_SCT\nPBMMC-1_AAACCTGCAGACGCAA-1     28.65473      0.1665973       4140          911\nPBMMC-1_AAACCTGTCATCACCC-1     55.03964      0.1981880       4402          759\nPBMMC-1_AAAGATGCATAAAGGT-1     30.43807      0.3776435       4376         1215\nPBMMC-1_AAAGCAAAGCAGCGTA-1     55.02942      0.3642477       4362          894\nPBMMC-1_AAAGCAACAATAACGA-1     54.49363      0.1006036       4301          731\nPBMMC-1_AAAGCAACATCAGTCA-1     23.40693     36.9682283       4550         1061\n                           RNA_snn_res.0.1 RNA_snn_res.0.2 RNA_snn_res.0.3\nPBMMC-1_AAACCTGCAGACGCAA-1               5               7               7\nPBMMC-1_AAACCTGTCATCACCC-1               0               0               0\nPBMMC-1_AAAGATGCATAAAGGT-1               2               3               3\nPBMMC-1_AAAGCAAAGCAGCGTA-1               0               0               0\nPBMMC-1_AAAGCAACAATAACGA-1               0               0               0\nPBMMC-1_AAAGCAACATCAGTCA-1               4               2               2\n                           RNA_snn_res.0.4 RNA_snn_res.0.5 RNA_snn_res.0.6\nPBMMC-1_AAACCTGCAGACGCAA-1               7               7               9\nPBMMC-1_AAACCTGTCATCACCC-1               0               0               0\nPBMMC-1_AAAGATGCATAAAGGT-1               2               3               3\nPBMMC-1_AAAGCAAAGCAGCGTA-1               0               0               0\nPBMMC-1_AAAGCAACAATAACGA-1               0               0               0\nPBMMC-1_AAAGCAACATCAGTCA-1               5               5               5\n                           RNA_snn_res.0.7 RNA_snn_res.0.8 seurat_clusters\nPBMMC-1_AAACCTGCAGACGCAA-1               9               8               8\nPBMMC-1_AAACCTGTCATCACCC-1               0               0               0\nPBMMC-1_AAAGATGCATAAAGGT-1               2               2               2\nPBMMC-1_AAAGCAAAGCAGCGTA-1               0               0               0\nPBMMC-1_AAAGCAACAATAACGA-1               0               0               0\nPBMMC-1_AAAGCAACATCAGTCA-1               5               5               5\n```\n\n\n:::\n:::\n\n\n\nTo view how clusters sub-divide at increasing resolution:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(clustree)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: ggraph\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLoading required package: ggplot2\n```\n\n\n:::\n\n```{.r .cell-code}\nclustree::clustree(seu@meta.data[,grep(\"RNA_snn_res\", colnames(seu@meta.data))],\n                   prefix = \"RNA_snn_res.\")\n```\n\n::: {.cell-output-display}\n![](day2-4_clustering_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\nYou can view the UMAP coloring each cell according to a cluster id like this:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSeurat::DimPlot(seu, group.by = \"RNA_snn_res.0.1\")\n```\n\n::: {.cell-output-display}\n![](day2-4_clustering_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n::: {.callout-important}\n## Exercise\nVisualise clustering based on a few more resolutions. Taking the clustering and the UMAP plots into account what do you consider as a good resolution to perform the clustering?\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\nOf course, there is no 'optimal' resolution, but based on resolution of 0.3, the tree stays relatively stable for a few resolution steps, and it seems that clustering fits the UMAP well:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSeurat::DimPlot(seu, group.by = \"RNA_snn_res.0.3\")\n```\n\n::: {.cell-output-display}\n![](day2-4_clustering_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n:::\n\n::: {.callout-important}\n## Exercise\nWhen do the number of neighbors need to be changed? How does changing the method of clustering in `FindClusters` affect the output? Which parameter should be changed?\n:::\n\n::: {.callout-tip collapse=\"true\"}\n## Answer\nAs FindClusters is an unsupervised clustering method on the PCA data and UMAP is a good summary of the PCA dimension selected, clusters and UMAP plot should go along. If one has reasons to change the number of neighbors in the UMAP function, here the same parameter should be adapted.\n    \nThe method can be changed with algorithm = 2,3 or 4\n:::\n\n\n\n::: {.cell}\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}