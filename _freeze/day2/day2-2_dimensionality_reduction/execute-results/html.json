{
  "hash": "9629b086294188c5d9590de87e6b4abd",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Dimensionality reduction\"\neditor_options: \n  chunk_output_type: console\n---\n\n\n\n\n## Material\n\n\n\n{{< downloadthis ../assets/pdf/202503_dimensionality_reduction.pdf dname=\"Dimensionality_Reduction_SIB\" label=\"Download the presentation\" icon=\"filetype-pdf\" >}}\n\n\n{{< video https://youtu.be/QS6ZH_41b4s?si=fvaNGkqjsIcxTEFn >}}\n\n\n{{< downloadthis ../assets/pdf/scRNAseq_RM_Integration_dimreduction.pdf dname=\"scRNAseq_RM_Integration_dimreduction\" label=\"Download the presentation from the video\" icon=\"filetype-pdf\" >}}\n\n\n\n\n- Making sense of [PCA](https://stats.stackexchange.com/questions/2691/making-sense-of-principal-component-analysis-eigenvectors-eigenvalues)\n- Understanding [t-SNE](https://distill.pub/2016/misread-tsne/)\n- [t-SNE explained](https://www.youtube.com/watch?v=NEaUSP4YerM) by Josh Starmer\n- Understanding [UMAP](https://pair-code.github.io/understanding-umap/)\n- [Video](https://www.youtube.com/watch?v=nq6iPZVUxZU) by one of the UMAP authors\n- More info on [UMAP parameters](https://umap.scikit-tda.org/parameters.html)\n\n\n\n\n## Exercises\n\nLoad the `seu` dataset you have created yesterday:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseu <- readRDS(\"day2/seu_day2-1.rds\")\n```\n:::\n\n\n\nAnd load the following packages:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(Seurat)\n```\n:::\n\n\n\nOnce the data is normalized, scaled and variable features have been identified, we can start to reduce the dimensionality of the data.\nFor the PCA, by default, only the previously determined variable features are used as input, but can be defined using features argument if you wish to specify a vector of genes. The PCA will only be run on the variable features, that you can check with `VariableFeatures(seu)`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseu <- Seurat::RunPCA(seu)\n```\n:::\n\n\n\nTo view the PCA plot:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSeurat::DimPlot(seu, reduction = \"pca\")\n```\n\n::: {.cell-output-display}\n![](day2-2_dimensionality_reduction_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\nWe can colour the PCA plot according to any factor that is present in `@meta.data`, or for any gene. For example we can take the column `percent.globin`:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSeurat::FeaturePlot(seu, reduction = \"pca\", features = \"percent.globin\")\n```\n\n::: {.cell-output-display}\n![](day2-2_dimensionality_reduction_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n::: {.callout-note}\nNote that we used a different plotting function here: `FeaturePlot`. The difference between `DimPlot` and `FeaturePlot` is that the first allows you to color the points in the plot according to a grouping variable (e.g. sample) while the latter allows you to color the points according to a continuous variable (e.g. gene expression).\n::: \n\n::: {.callout-important}\n## Exercise\nGenerate a PCA plot where color is according to counts of a gene (i.e. gene expression). For example, you can take `HBA1` (alpha subunit of hemoglobin), or one of the most variable genes (e.g. `IGKC`).\n::: \n\n::: {.callout-tip collapse=\"true\"}\n## Answer\nGenerating a PCA plot coloured according to gene expression (here `HBA1`):\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSeurat::FeaturePlot(seu, reduction = \"pca\", features = \"HBA1\")\n```\n\n::: {.cell-output-display}\n![](day2-2_dimensionality_reduction_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n:::\n\n\nWe can generate heatmaps according to their principal component scores calculated in the rotation matrix:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSeurat::DimHeatmap(seu, dims = 1:12, cells = 500, balanced = TRUE)\n```\n\n::: {.cell-output-display}\n![](day2-2_dimensionality_reduction_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\nThe elbowplot can help you in determining how many PCs to use for downstream analysis such as UMAP:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSeurat::ElbowPlot(seu, ndims = 40) +\n  ggplot2::geom_vline(xintercept = 25, linetype = \"dashed\", color = \"red\", linewidth = 1)\n```\n\n::: {.cell-output-display}\n![](day2-2_dimensionality_reduction_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\nThe elbow plot ranks principle components based on the percentage of variance explained by each one. Where we observe an \"elbow\" or flattening curve, the majority of true signal is captured by this number of PCs, eg around 25 PCs for the seu dataset.\n\nIncluding too many PCs usually does not affect much the result, while including too few PCs can affect the results very much.\n\n**UMAP:** The goal of these algorithms is to learn the underlying manifold of the data in order to place similar cells together in low-dimensional space.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseu <- Seurat::RunUMAP(seu, dims = 1:25)\n```\n:::\n\n\n\nTo view the UMAP plot:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSeurat::DimPlot(seu, reduction = \"umap\")\n```\n\n::: {.cell-output-display}\n![](day2-2_dimensionality_reduction_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n::: {.callout-important}\n## Exercise\n\nTry to change:\n\n**A.** Color the dots in the UMAP according to a variable (e.g. `percent.globin` or `HBA1`). Any idea where the erythrocytes probably are in the UMAP?\n\n**B.** The number of neighbors used for the calculation of the UMAP. Which is the parameter to change and how did it affect the output. What is the default ? In which situation would you lower/increase this ?\n\n**C.** The number of dims to extremes `dims = 1:5` or `dims = 1:50` how\ndid it affect the output ? In your opinion better few PCAs too much or too few ?\nWhy does `dims = 1:100` not work? When would more precision be needed?\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n\n## Answer\n\n**Answer A** \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSeurat::FeaturePlot(seu, features = c(\"HBA1\",\n                                      \"percent.globin\",\n                                      \"IGKC\",\n                                      \"percent.mito\"))\n```\n\n::: {.cell-output-display}\n![](day2-2_dimensionality_reduction_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\nThe erythrocytes are probably in the cluster with a higher percentage of globin expression.\n\n**Answer B**\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseu <- Seurat::RunUMAP(seu, dims = 1:25, n.neighbors = 5)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nSeurat::DimPlot(seu, reduction = \"umap\")\n```\n\n::: {.cell-output-display}\n![](day2-2_dimensionality_reduction_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\nThe default number of neighbours is 30. It can be of interest to change the number of neighbors if one has subset the data (for instance in the situation where you would only consider the t-cells in your data set), then maybe the number of neighbors in a cluster would anyway be most of the time lower than 30 then 30 is too much. In the other extreme where your dataset is extremely big an increase in the number of neighbors can be considered.\n\n**Answer C** \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseu <- Seurat::RunUMAP(seu, dims = 1:5)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nSeurat::DimPlot(seu, reduction = \"umap\")\n```\n\n::: {.cell-output-display}\n![](day2-2_dimensionality_reduction_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nseu <- Seurat::RunUMAP(seu, dims = 1:50) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nSeurat::DimPlot(seu, reduction = \"umap\")\n```\n\n::: {.cell-output-display}\n![](day2-2_dimensionality_reduction_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n\nTaking dims = 1:100 does not work as in the step `RunPCA` by default only 50pcs are calculated, so the maximum that we can consider in further steps are 50, if more precision makes sense, for instance, if the genes that is of interest for your study is not present when the `RunPCA` was calculated, then an increase in the number of components calculated at start might be interesting tobe considered. Taking too few PCs we have a « blob » everything looks connected. Too many PCs tends to separate everything. Personally it is more interesting for me too have maybe 2 clusters separated of epithelial cells that I then group for further downstream analysis rather than having very distinct cells being clustered together. So I would rather take the « elbow » of the elbow plot a bit further to the right.\n\n:::\n\n::: {callout-warning}\nAfter having done these exercises, change the UMAP back to a UMAP based on the first 25 PCs, in order to replicate the exercises in the following chapters. Do this by:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseu <- Seurat::RunUMAP(seu, dims = 1:25)\n```\n:::\n\n\n\n:::\n\n\n\n::: {.cell}\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}